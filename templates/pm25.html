<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <link rel="stylesheet" href="{{ url_for('static',filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/echarts@6.0.0/dist/echarts.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

</head>

<body>
  {{counts}}
  <h1>pm2.5數據列表</h1>
  <a href="/update-db">更新資料庫</a>

  <div id="main" style="width: 800px;height:600px;"></div>
  <div id="count" style="width: 800px;height:600px;" hidden></div>

  <div style="margin: 12px">
    <label for="countSelect">選擇縣市</label>
    <select name="countSelect" id="countSelect">
      {% for count in counts %}
      <option value={{count}}>{{count}}</option>
      {% endfor %}
    </select>
    <button id="loadCount" onclick="drawCountChart()">確定</button>
  </div>

  <div id="tableContainer">
    <table border="1px">
      <thead>
        <tr>
          {% for col in columns %}
          <th>{{col}}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for value in values %}
        <tr>
          {% for data in value %}
          <td>
            {{data}}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <script type="text/javascript">
    const Chart1 = echarts.init(document.getElementById('main'));

    const Chart2 = echarts.init(document.getElementById('count'));
    const countEl = document.getElementById('count')
    const countSelectEl = document.querySelector("#countSelect");

    console.log(countSelectEl)

    drawChart(Chart1, "/avg-pm25", "各縣市PM2.5平均值", "count", "pm25", "green")

    function drawCountChart() {
      count = countSelectEl.value;
      countEl.hidden = false;
      console.log(count);
      drawChart(Chart2, `/count-pm25/${count}`, `${count}PM2.5數據圖`, "site", "pm25", "red")
    }

    function drawChart(chart, url, title, xKey, yKey, color) {
      $.ajax(
        {
          url: url,
          type: "GET",
          dataType: "json",
          success: (result) => {
            console.log(result);
            // 指定图表的配置项和数据
            var option = {
              title: {
                text: title
              },
              tooltip: {},
              legend: {
                data: ['PM2.5']
              },
              xAxis: {
                data: result[xKey]
              },
              yAxis: {},
              series: [
                {
                  itemStyle: {
                    color: color
                  },
                  name: 'PM2.5',
                  type: 'bar',
                  data: result[yKey]
                }
              ]
            };

            // 使用刚指定的配置项和数据显示图表。
            chart.setOption(option);
          },
          error: () => {
            console.log("讀取資料失敗...")
          }
        }
      )
    }

  </script>
</body>

</html>